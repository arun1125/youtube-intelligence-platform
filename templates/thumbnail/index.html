{% extends "base.html" %}

{% block title %}YouTube Context Engine - Test Your Thumbnail{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Left: Input Form -->
    <div class="lg:col-span-1">
        <div class="bg-yt-card rounded-lg p-6 sticky top-24">
            <h2 class="text-2xl font-bold mb-6">Test Your Thumbnail</h2>

            <form
                action="/generate"
                method="POST"
                enctype="multipart/form-data"
                class="space-y-6"
            >
                <!-- Persona Input -->
                <div>
                    <label for="persona" class="block text-sm font-medium mb-2">
                        Target Viewer Persona <span class="text-red-500">*</span>
                    </label>
                    <textarea
                        id="persona"
                        name="persona"
                        rows="4"
                        required
                        placeholder="e.g., 25yo Junior Developer who loves TypeScript and watches tech content during lunch breaks"
                        class="w-full bg-yt-bg border border-gray-700 rounded-lg px-4 py-2 text-yt-text placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-yt-accent"
                    ></textarea>
                    <p class="text-xs text-yt-text-secondary mt-1">
                        Be specific! The more detail, the better the channel suggestions.
                    </p>
                </div>

                <!-- Video Title -->
                <div>
                    <label for="title" class="block text-sm font-medium mb-2">
                        Video Title <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="text"
                        id="title"
                        name="title"
                        required
                        maxlength="100"
                        placeholder="Your amazing video title"
                        class="w-full bg-yt-bg border border-gray-700 rounded-lg px-4 py-2 text-yt-text placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-yt-accent"
                    />
                </div>

                <!-- Thumbnail Upload -->
                <div>
                    <label for="thumbnail" class="block text-sm font-medium mb-2">
                        Thumbnail Image <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="file"
                        id="thumbnail"
                        name="thumbnail"
                        required
                        accept="image/*"
                        class="w-full bg-yt-bg border border-gray-700 rounded-lg px-4 py-2 text-yt-text file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-yt-accent file:text-white hover:file:bg-blue-600 file:cursor-pointer focus:outline-none focus:ring-2 focus:ring-yt-accent"
                    />
                    <p class="text-xs text-yt-text-secondary mt-1">
                        Recommended: 1280x720px (16:9 aspect ratio)
                    </p>
                </div>

                <!-- Channel Avatar (Optional) -->
                <div>
                    <label for="avatar" class="block text-sm font-medium mb-2">
                        Channel Avatar <span class="text-gray-500">(Optional)</span>
                    </label>
                    <input
                        type="file"
                        id="avatar"
                        name="avatar"
                        accept="image/*"
                        class="w-full bg-yt-bg border border-gray-700 rounded-lg px-4 py-2 text-yt-text file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-gray-700 file:text-white hover:file:bg-gray-600 file:cursor-pointer focus:outline-none focus:ring-2 focus:ring-yt-accent"
                    />
                </div>

                <!-- Submit Button -->
                <button
                    type="submit"
                    class="w-full bg-yt-accent hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2"
                >
                    <span id="button-text">Generate Preview</span>
                    <svg id="loading-spinner" class="htmx-indicator animate-spin h-5 w-5 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="display: none;">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>

                <style>
                    .htmx-request #loading-spinner {
                        display: inline-block !important;
                    }
                    .htmx-request #button-text {
                        opacity: 0.7;
                    }
                </style>
            </form>

            <script>
                console.log('Progress tracking script loaded!');

                // Show loading overlay on form submit
                document.querySelector('form').addEventListener('submit', function(e) {
                    console.log('Form submitted, showing overlay');
                    const overlay = document.getElementById('loading-overlay');
                    if (overlay) {
                        overlay.style.display = 'flex';

                        // Start progress simulation
                        setTimeout(() => updateStepProgress('step-ai', 'active'), 100);
                        setTimeout(() => {
                            updateStepProgress('step-ai', 'complete');
                            updateStepProgress('step-resolve', 'active');
                        }, 10000);
                        setTimeout(() => {
                            updateStepProgress('step-resolve', 'complete');
                            updateStepProgress('step-fetch', 'active');
                        }, 16000);
                        setTimeout(() => {
                            updateStepProgress('step-fetch', 'complete');
                            updateStepProgress('step-save', 'active');
                        }, 30000);
                        setTimeout(() => {
                            updateStepProgress('step-save', 'complete');
                            updateStepProgress('step-build', 'active');
                        }, 32000);
                    }
                });

                // Progress tracking
                function updateStepProgress(stepId, status) {
                    const step = document.getElementById(stepId);
                    if (!step) return;

                    const indicator = step.querySelector('.w-6');
                    const text = step.querySelector('p');

                    if (status === 'active') {
                        step.classList.remove('opacity-50');
                        step.classList.add('bg-yt-bg');
                        indicator.innerHTML = '<div class="w-2 h-2 bg-yt-accent rounded-full animate-pulse"></div>';
                        indicator.classList.remove('border-gray-600');
                        indicator.classList.add('border-yt-accent');
                        text.classList.remove('text-gray-400');
                        text.classList.add('text-yt-text');
                    } else if (status === 'complete') {
                        step.classList.remove('opacity-50', 'bg-yt-bg');
                        indicator.innerHTML = '<svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
                        indicator.classList.remove('border-gray-600', 'border-yt-accent');
                        indicator.classList.add('border-green-500', 'bg-green-500');
                        text.classList.remove('text-gray-400');
                        text.classList.add('text-green-400');
                    }
                }

            </script>

            <!-- Info Box -->
            <div class="mt-6 p-4 bg-yt-bg rounded-lg border border-gray-700">
                <h3 class="text-sm font-semibold mb-2 text-yt-accent">How it works:</h3>
                <ol class="text-xs text-yt-text-secondary space-y-1 list-decimal list-inside">
                    <li>AI finds 10 channels your persona watches</li>
                    <li>Fetches 2 recent videos from each channel</li>
                    <li>Injects your video into the mix</li>
                    <li>Shows you in a 3x3 grid (20 total videos)</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Right: Results Grid -->
    <div class="lg:col-span-2">
        <div class="relative">
            <!-- Loading Overlay with Progress Steps (Outside of results-container) -->
            <div id="loading-overlay" class="absolute inset-0 bg-yt-bg bg-opacity-95 flex flex-col items-center justify-center rounded-lg z-10 p-8" style="display: none;">
                <div class="max-w-md w-full">
                    <div class="text-center mb-8">
                        <svg class="animate-spin h-12 w-12 text-yt-accent mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-xl font-semibold text-yt-text">Generating Preview...</p>
                    </div>

                    <!-- Progress Steps -->
                    <div class="space-y-3">
                        <!-- Step 1: AI Channel Suggestions -->
                        <div id="step-ai" class="flex items-center space-x-3 p-3 rounded-lg bg-yt-card">
                            <div class="flex-shrink-0">
                                <div class="w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center">
                                    <div class="w-2 h-2 bg-gray-600 rounded-full animate-pulse"></div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-400">Getting AI channel suggestions...</p>
                            </div>
                        </div>

                        <!-- Step 2: Resolving Channel IDs -->
                        <div id="step-resolve" class="flex items-center space-x-3 p-3 rounded-lg bg-yt-card opacity-50">
                            <div class="flex-shrink-0">
                                <div class="w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center">
                                    <div class="w-2 h-2 bg-gray-600 rounded-full"></div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-400">Resolving channel IDs...</p>
                            </div>
                        </div>

                        <!-- Step 3: Fetching Videos -->
                        <div id="step-fetch" class="flex items-center space-x-3 p-3 rounded-lg bg-yt-card opacity-50">
                            <div class="flex-shrink-0">
                                <div class="w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center">
                                    <div class="w-2 h-2 bg-gray-600 rounded-full"></div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-400">Fetching videos from YouTube...</p>
                            </div>
                        </div>

                        <!-- Step 4: Saving to Database -->
                        <div id="step-save" class="flex items-center space-x-3 p-3 rounded-lg bg-yt-card opacity-50">
                            <div class="flex-shrink-0">
                                <div class="w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center">
                                    <div class="w-2 h-2 bg-gray-600 rounded-full"></div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-400">Saving to database...</p>
                            </div>
                        </div>

                        <!-- Step 5: Building Grid -->
                        <div id="step-build" class="flex items-center space-x-3 p-3 rounded-lg bg-yt-card opacity-50">
                            <div class="flex-shrink-0">
                                <div class="w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center">
                                    <div class="w-2 h-2 bg-gray-600 rounded-full"></div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-400">Building your grid...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Container (HTMX swaps content here) -->
            <div id="results-container">
                {% if recent_test_html %}
                    <!-- Most Recent Test -->
                    {{ recent_test_html|safe }}
                {% else %}
                <!-- Welcome Message (shown before first generation) -->
                <div class="text-center py-16">
                <svg class="w-24 h-24 mx-auto mb-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <h3 class="text-2xl font-semibold mb-3 text-yt-text-secondary">Ready to test your thumbnail?</h3>
                <p class="text-yt-text-secondary mb-6">
                    Fill out the form and see how your video stacks up against real competition.
                </p>
                <div class="flex justify-center space-x-6 text-sm">
                    <div class="flex items-center space-x-2 text-yt-text-secondary">
                        <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span>Real channels</span>
                    </div>
                    <div class="flex items-center space-x-2 text-yt-text-secondary">
                        <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span>Real data</span>
                    </div>
                    <div class="flex items-center space-x-2 text-yt-text-secondary">
                        <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span>Instant results</span>
                    </div>
                </div>
                </div>
                <!-- End of welcome message -->
                {% endif %}
            </div>
            <!-- End of results-container -->
        </div>
        <!-- End of wrapper div -->
    </div>
    <!-- End of col-span-2 -->
</div>
<!-- End of grid -->
{% endblock %}
