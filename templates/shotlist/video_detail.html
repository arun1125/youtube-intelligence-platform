{% extends "base.html" %}

{% block title %}{{ video.title }} - Shot List - YouTube Creator Tools{% endblock %}

{% block extra_head %}
<!-- SortableJS for drag-and-drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.1/Sortable.min.js"></script>
<style>
    .sortable-ghost {
        opacity: 0.4;
        background: #272727;
    }
    .sortable-drag {
        opacity: 1;
    }
    .script-text {
        transition: font-family 0.2s;
    }
    .font-serif {
        font-family: Georgia, Cambria, serif;
    }
    .font-mono {
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-6">
            <a href="/shotlist" class="text-yt-text-secondary hover:text-yt-text text-sm">
                ‚Üê Back to Shot List
            </a>

            <!-- Project Selector -->
            <div class="flex items-center gap-2">
                <label class="text-xs font-semibold text-yt-text-secondary uppercase tracking-wider">Project:</label>
                <select
                    onchange="updateProject(this.value)"
                    class="bg-yt-card border border-gray-800 text-yt-text text-sm rounded-lg px-3 py-2 focus:outline-none focus:border-yt-accent transition-colors"
                >
                    <option value="">No Project</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}" {% if video.project_id == project.id %}selected{% endif %}>{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Idea Section -->
        <div class="mt-6 mb-6">
            <label class="text-xs font-semibold text-yt-text-secondary uppercase tracking-wider mb-2 block">Idea</label>
            <textarea
                placeholder="What's the video idea?"
                class="bg-yt-card border border-gray-800 text-yt-text text-base focus:outline-none focus:border-yt-accent w-full rounded-lg p-3 resize-none"
                onblur="updateField('{{ video.id }}', 'idea', this.value)"
                rows="2"
            >{{ video.idea if video.idea else '' }}</textarea>
        </div>

        <!-- Hook and Thumbnail Section - Side by Side -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Hook Section -->
            <div>
                <label class="text-xs font-semibold text-yt-text-secondary uppercase tracking-wider mb-2 block">Hook</label>
                <textarea
                    placeholder="What's the hook?"
                    class="bg-yt-card border border-gray-800 text-yt-text text-base focus:outline-none focus:border-yt-accent w-full rounded-lg p-3 resize-none"
                    onblur="updateField('{{ video.id }}', 'hook', this.value)"
                    rows="2"
                >{{ video.hook if video.hook else '' }}</textarea>
            </div>

            <!-- Thumbnail Description Section -->
            <div>
                <label class="text-xs font-semibold text-yt-text-secondary uppercase tracking-wider mb-2 block">Thumbnail Description</label>
                <textarea
                    placeholder="Describe the thumbnail..."
                    class="bg-yt-card border border-gray-800 text-yt-text text-base focus:outline-none focus:border-yt-accent w-full rounded-lg p-3 resize-none"
                    onblur="updateField('{{ video.id }}', 'thumbnail_description', this.value)"
                    rows="2"
                >{{ video.thumbnail_description if video.thumbnail_description else '' }}</textarea>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="mb-8">
            <label class="text-xs font-semibold text-yt-text-secondary uppercase tracking-wider mb-2 block">Planning Notes</label>
            <textarea
                id="notes-textarea"
                placeholder="Word vomit everything in your head..."
                class="bg-yt-card border border-gray-800 text-yt-text text-base focus:outline-none focus:border-yt-accent w-full rounded-lg p-3 resize-none overflow-hidden"
                onblur="updateField('{{ video.id }}', 'notes', this.value)"
                rows="3"
            >{{ video.notes if video.notes else '' }}</textarea>
        </div>

        <div class="flex justify-between items-start mt-4">
            <div class="flex-1">
                <h1 class="text-4xl font-bold tracking-tight mb-2">{{ video.title }}</h1>
                <input
                    type="text"
                    value="{{ video.global_vibe if video.global_vibe else '' }}"
                    placeholder="What's the shotlist vibe?"
                    class="bg-transparent border-none text-yt-text-secondary text-lg focus:outline-none focus:text-yt-text w-full"
                    onblur="updateField('{{ video.id }}', 'global_vibe', this.value)"
                >
            </div>

            <!-- Font Toggle -->
            <div class="flex items-center gap-2 bg-yt-card border border-gray-800 rounded-lg p-2">
                <button
                    id="font-serif"
                    onclick="toggleFont('serif')"
                    class="px-3 py-2 rounded text-sm transition-all {% if video.font_preference == 'serif' %}bg-yt-hover text-white{% else %}text-yt-text-secondary{% endif %}"
                >
                    Aa
                </button>
                <button
                    id="font-mono"
                    onclick="toggleFont('mono')"
                    class="px-3 py-2 rounded text-sm font-mono transition-all {% if video.font_preference == 'mono' %}bg-yt-hover text-white{% else %}text-yt-text-secondary{% endif %}"
                >
                    {'<>'}
                </button>
            </div>
        </div>
    </div>

    <!-- Desktop Table View -->
    <div class="hidden md:block bg-yt-card border border-gray-800 rounded-xl overflow-hidden">
        <table class="w-full">
            <thead class="bg-yt-bg border-b border-gray-800">
                <tr>
                    <th class="w-12 px-4 py-3 text-left text-xs font-semibold text-yt-text-secondary uppercase tracking-wider">#</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-yt-text-secondary uppercase tracking-wider">Roll</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-yt-text-secondary uppercase tracking-wider">Shot Type</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-yt-text-secondary uppercase tracking-wider">Description</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-yt-text-secondary uppercase tracking-wider">Script</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-yt-text-secondary uppercase tracking-wider">Vibes</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-yt-text-secondary uppercase tracking-wider">Music Vibes</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-yt-text-secondary uppercase tracking-wider">Music Inspo</th>
                    <th class="w-12 px-4 py-3"></th>
                </tr>
            </thead>
            <tbody id="shots-table" class="divide-y divide-gray-800">
                {% for shot in shots %}
                {% include 'shotlist/partials/shot_row.html' %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Mobile Card View -->
    <div class="md:hidden space-y-4" id="shots-mobile">
        {% for shot in shots %}
        {% include 'shotlist/partials/shot_card.html' %}
        {% endfor %}
    </div>

    <!-- Add Shot Button -->
    <button
        onclick="addShot()"
        class="mt-6 w-full py-4 bg-yt-card border border-gray-800 rounded-xl text-yt-text-secondary hover:text-yt-text hover:border-yt-accent transition-all"
    >
        + Add Shot
    </button>
</div>

<script>
let currentFont = '{{ video.font_preference }}';

function updateField(videoId, field, value) {
    const formData = new FormData();
    formData.append('field', field);
    formData.append('value', value);

    fetch(`/api/shotlist/videos/${videoId}`, {
        method: 'PUT',
        body: formData
    });
}

function toggleFont(font) {
    currentFont = font;

    // Update UI
    document.getElementById('font-serif').classList.toggle('bg-yt-hover', font === 'serif');
    document.getElementById('font-serif').classList.toggle('text-white', font === 'serif');
    document.getElementById('font-serif').classList.toggle('text-yt-text-secondary', font !== 'serif');

    document.getElementById('font-mono').classList.toggle('bg-yt-hover', font === 'mono');
    document.getElementById('font-mono').classList.toggle('text-white', font === 'mono');
    document.getElementById('font-mono').classList.toggle('text-yt-text-secondary', font !== 'mono');

    // Update all script cells
    document.querySelectorAll('.script-text').forEach(el => {
        el.className = 'script-text ' + (font === 'serif' ? 'font-serif' : 'font-mono');
    });

    // Save preference
    updateField('{{ video.id }}', 'font_preference', font);
}

// Update project
function updateProject(projectId) {
    updateField('{{ video.id }}', 'project_id', projectId);
}

// Auto-expand textarea
function autoExpandTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

// Initialize Sortable and auto-expand textarea
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('shots-table');
    if (table) {
        new Sortable(table, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            onEnd: function(evt) {
                const rows = table.querySelectorAll('tr');
                const shotIds = Array.from(rows).map(row => row.dataset.shotId);

                fetch('/api/shotlist/shots/reorder', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({shot_ids: shotIds})
                });
            }
        });
    }

    // Setup auto-expanding notes textarea
    const notesTextarea = document.getElementById('notes-textarea');
    if (notesTextarea) {
        notesTextarea.addEventListener('input', function() {
            autoExpandTextarea(this);
        });
        autoExpandTextarea(notesTextarea);
    }
});

function editCell(element, shotId, field) {
    const currentValue = element.textContent.trim();
    const isTextarea = field === 'script_line' || field === 'shot_description';

    const input = document.createElement(isTextarea ? 'textarea' : 'input');
    input.value = currentValue;
    input.className = element.className + ' bg-yt-bg px-2 py-1 rounded border border-yt-accent focus:outline-none focus:border-yt-accent';

    if (isTextarea) {
        input.rows = 2;
    }

    input.onblur = function() {
        const newValue = input.value;
        element.textContent = newValue;

        const formData = new FormData();
        formData.append('field', field);
        formData.append('value', newValue);

        fetch(`/api/shotlist/shots/${shotId}`, {
            method: 'PUT',
            body: formData
        });
    };

    input.onkeydown = function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            input.blur();
        }
        if (e.key === 'Escape') {
            element.textContent = currentValue;
            input.blur();
        }
    };

    element.textContent = '';
    element.appendChild(input);
    input.focus();
}

function deleteShot(shotId, rowElement) {
    if (confirm('Delete this shot?')) {
        fetch(`/api/shotlist/shots/${shotId}`, {
            method: 'DELETE'
        }).then(() => {
            rowElement.remove();
        });
    }
}

function addShot() {
    const formData = new FormData();
    formData.append('video_id', '{{ video.id }}');

    fetch('/api/shotlist/shots', {
        method: 'POST',
        body: formData
    }).then(() => {
        location.reload();
    });
}
</script>
{% endblock %}
